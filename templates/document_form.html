{% extends 'base.html' %}

{% block title %}{% if document %}‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç{% else %}‡∏™‡∏£‡πâ‡∏≤‡∏á{% endif %}{{ doc_info.name_th }}{% endblock %}

{% block content %}
<style>
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }

    .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover {
        background-color: #f3f4f6;
    }
</style>
<form method="POST" id="documentForm">
    <!-- ========== HEADER BAR ========== -->
    <div class="doc-form-header">
        <div class="doc-title">
            <div>
                <div class="doc-type-label">
                    <i class="{{ doc_info.icon }}" style="color: {{ doc_info.color }}"></i>
                    {% if document %}‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç{% else %}‡∏™‡∏£‡πâ‡∏≤‡∏á{% endif %}{{ doc_info.name_th }}
                </div>
                <div class="doc-number-row">
                    <span class="doc-number">{{ doc_number }}</span>
                    {% if document %}
                    {% set st = doc_statuses.get(document.status, doc_statuses['draft']) %}
                    <span class="status-badge-inline"
                        style="background:{{ st.bg }}; color:{{ st.color }}; border:1px solid {{ st.color }}30;">
                        {{ st.name_th }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="doc-form-actions">
            <a href="{{ url_for('document_list', doc_type=doc_type) }}" class="btn btn-secondary">
                <i class="ri-arrow-left-line"></i> ‡∏î‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πà‡∏≤‡∏á
            </a>
            <div class="save-btn-group">
                <button type="submit" name="status" value="saved" class="btn btn-primary btn-lg">
                    <i class="ri-save-line"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                </button>
                <div class="save-dropdown-wrapper">
                    <button type="button" class="btn btn-primary btn-lg save-dropdown-toggle"
                        onclick="this.parentElement.classList.toggle('open')">
                        <i class="ri-arrow-down-s-line"></i>
                    </button>
                    <div class="save-dropdown-menu">
                        <button type="submit" name="status" value="draft" class="save-dropdown-item">
                            <i class="ri-draft-line"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á
                        </button>
                        <button type="submit" name="status" value="approved" class="save-dropdown-item">
                            <i class="ri-check-line"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" name="doc_number" value="{{ doc_number }}">

    <!-- ========== TOP SECTION: Customer (left) + Actions + Totals/Dates (right) ========== -->
    <div class="doc-form-body">
        <!-- LEFT: Customer Section -->
        <div class="customer-section">
            <div class="form-group customer-autocomplete">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                <input type="hidden" name="customer_id" id="customerId"
                    value="{{ document.customer_id if document and document.customer_id else '' }}">
                <div style="position:relative;">
                    <input type="text" class="form-control" name="customer_name" id="customerName"
                        value="{{ document.customer.name if document and document.customer else '' }}"
                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." autocomplete="off">
                    <!-- Custom Dropdown -->
                    <div id="customerDropdown" class="autocomplete-dropdown"></div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                <textarea class="form-control" name="customer_address" rows="3"
                    placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà">{{ document.customer.address if document and document.customer else '' }}</textarea>
            </div>
            <div class="form-row-2col">
                <div class="form-group">
                    <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                    <input type="text" class="form-control" name="customer_zipcode" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå"
                        value="{{ document.customer.zipcode if document and document.customer and document.customer.zipcode else '' }}">
                </div>
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</label>
                    <input type="text" class="form-control" name="customer_tax_id" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ"
                        value="{{ document.customer.tax_id if document and document.customer else '' }}">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô/‡∏™‡∏≤‡∏Ç‡∏≤</label>
                <input type="text" class="form-control" name="customer_branch" placeholder="‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà"
                    value="{{ document.customer.branch if document and document.customer else '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà' }}">
            </div>

            <!-- Action Icons (share, print, copy, more) -->
            <div class="action-icons">
                <button type="button" class="action-icon-btn" title="‡πÅ‡∏ä‡∏£‡πå">
                    <i class="ri-share-line"></i>
                    <span>‡πÅ‡∏ä‡∏£‡πå</span>
                </button>
                <button type="button" class="action-icon-btn" onclick="window.print()" title="‡∏û‡∏¥‡∏°‡∏û‡πå">
                    <i class="ri-printer-line"></i>
                    <span>‡∏û‡∏¥‡∏°‡∏û‡πå</span>
                </button>
                <button type="button" class="action-icon-btn" title="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å">
                    <i class="ri-file-copy-line"></i>
                    <span>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</span>
                </button>
                <button type="button" class="action-icon-btn" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
                    <i class="ri-more-2-line"></i>
                    <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                </button>
            </div>
        </div>

        <!-- RIGHT: Grand Total + Dates -->
        <div class="totals-section">
            <div class="grand-total-display">
                <div class="grand-total-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</div>
                <div class="grand-total-amount" id="displayGrandTotal">‡∏ø{{ document.grand_total|format_number if
                    document else '0.00' }}</div>
            </div>
            <div class="dates-grid">
                <div class="form-group">
                    <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" class="form-control" name="doc_date" id="docDate"
                        value="{{ document.doc_date.strftime('%Y-%m-%d') if document and document.doc_date else today.strftime('%Y-%m-%d') }}">
                </div>
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏ß‡∏±‡∏ô):</label>
                    <select class="form-control" name="credit_days" id="creditDays" onchange="updateDueDate()">
                        {% for days in [0, 7, 15, 30, 45, 60, 90] %}
                        <option value="{{ days }}" {% if (document and document.credit_days==days) or (not document and
                            days==30) %}selected{% endif %}>
                            {{ days }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</label>
                    <input type="date" class="form-control" name="due_date" id="dueDate"
                        value="{{ document.due_date.strftime('%Y-%m-%d') if document and document.due_date else today.strftime('%Y-%m-%d') }}">
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢:</label>
                    <input type="text" class="form-control" name="salesperson" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢"
                        value="{{ document.salesperson if document else '' }}">
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô:</label>
                    <div class="currency-display">üáπüá≠ THB - ‡πÑ‡∏ó‡∏¢</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== REFERENCE ROW ========== -->
    <div class="reference-row">
        <div class="form-group" style="margin-bottom:0;">
            <label class="form-label">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ:</label>
            <input type="text" class="form-control" name="project" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ"
                value="{{ document.project if document else '' }}">
        </div>
        <div class="form-group" style="margin-bottom:0;">
            <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</label>
            <input type="text" class="form-control" name="reference_number" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á"
                value="{{ document.reference_number if document else '' }}">
        </div>
        <div class="form-group" style="margin-bottom:0;">
            <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
            <select class="form-control" name="price_type">
                <option value="‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ" {% if document and document.price_type=='‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ' %}selected{%
                    endif %}>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ</option>
                <option value="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ" {% if document and document.price_type=='‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ' %}selected{% endif %}>
                    ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ</option>
            </select>
        </div>
    </div>

    <!-- ========== ITEMS SECTION ========== -->
    <div class="items-section">
        <div class="section-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
        <table class="items-table" id="itemsTable">
            <colgroup>
                <col style="width:60px;">
                <col>
                <col style="width:100px;">
                <col style="width:80px;">
                <col style="width:130px;">
                <col style="width:130px;">
                <col style="width:40px;">
            </colgroup>
            <thead>
                <tr>
                    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th>
                    <th class="row-delete"></th>
                </tr>
            </thead>
            <tbody id="itemsBody">
                {% if document and document.items %}
                {% for item in document.items %}
                <tr class="item-row">
                    <td>{{ loop.index }}</td>
                    <td>
                        <input type="text" name="item_description[]" value="{{ item.description }}"
                            placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£" class="form-control mb-1">
                        <textarea name="item_details[]" class="form-control item-details-input"
                            placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏Å‡∏î Shift+Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)"
                            rows="1">{{ item.details or '' }}</textarea>
                    </td>
                    <td><input type="number" name="item_quantity[]" value="{{ item.quantity }}" step="any" min="0"
                            class="qty-input" onchange="calcRow(this)"></td>
                    <td><input type="text" name="item_unit[]" value="{{ item.unit }}" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢"></td>
                    <td><input type="number" name="item_unit_price[]" value="{{ item.unit_price }}" step="any" min="0"
                            class="price-input" onchange="calcRow(this)"></td>
                    <td class="amount-cell">
                        <span class="row-amount">{{ item.amount|format_number }}</span>
                        <input type="hidden" name="item_amount[]" value="{{ item.amount }}">
                    </td>
                    <td class="row-delete"><button type="button" onclick="removeRow(this)"><i
                                class="ri-close-line"></i></button></td>
                </tr>
                {% endfor %}
                {% else %}
                {% for i in range(3) %}
                <tr class="item-row">
                    <td>{{ i + 1 }}</td>
                    <td>
                        <input type="text" name="item_description[]" value="" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£"
                            class="form-control mb-1">
                        <textarea name="item_details[]" class="form-control item-details-input"
                            placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏Å‡∏î Shift+Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)" rows="1"></textarea>
                    </td>
                    <td><input type="number" name="item_quantity[]" value="" step="any" min="0" class="qty-input"
                            onchange="calcRow(this)"></td>
                    <td><input type="text" name="item_unit[]" value="" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢"></td>
                    <td><input type="number" name="item_unit_price[]" value="" step="any" min="0" class="price-input"
                            onchange="calcRow(this)"></td>
                    <td class="amount-cell">
                        <span class="row-amount">0.00</span>
                        <input type="hidden" name="item_amount[]" value="0">
                    </td>
                    <td class="row-delete"><button type="button" onclick="removeRow(this)"><i
                                class="ri-close-line"></i></button></td>
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
        <button type="button" class="add-row-btn" onclick="addRow()">
            <i class="ri-add-line"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </button>
    </div>

    <!-- ========== BOTTOM: Notes (left) + Summary (right) ========== -->
    <div class="doc-form-bottom">
        <!-- LEFT: Notes -->
        <div class="notes-section">
            <div class="form-group">
                <label class="form-check">
                    <input type="checkbox" checked disabled>
                    <span>‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏≤‡∏ö‡∏≤‡∏á</span>
                </label>
            </div>
            <div class="notes-columns">
                <div class="form-group">
                    <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</label>
                    <textarea class="form-control" name="notes" rows="4"
                        placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ñ‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">{{ document.notes if document else '' }}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">‡πÇ‡∏ô‡πâ‡∏ï‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</label>
                    <textarea class="form-control" name="internal_notes" rows="4"
                        placeholder="‡πÇ‡∏ô‡πâ‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô)">{{ document.internal_notes if document else '' }}</textarea>
                </div>
            </div>
        </div>

        <!-- RIGHT: Summary/Totals -->
        <div class="summary-section">
            <div class="summary-row">
                <span class="summary-label">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                <span class="summary-value" id="subtotalDisplay">0.00</span>
                <input type="hidden" name="subtotal" id="subtotal" value="{{ document.subtotal if document else 0 }}">
            </div>
            <div class="summary-row">
                <span class="summary-label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
                <div class="discount-input-group">
                    <input type="number" name="discount_percent" id="discountPercent"
                        value="{{ document.discount_percent if document else 0 }}" step="any" min="0" max="100"
                        onchange="calcTotals()">
                    <span>%</span>
                </div>
                <span class="summary-value edit-icon-value">
                    <i class="ri-pencil-line"></i>
                    <span id="discountDisplay">0.00</span>
                </span>
                <input type="hidden" name="discount_amount" id="discountAmount"
                    value="{{ document.discount_amount if document else 0 }}">
            </div>
            <div class="summary-row">
                <span class="summary-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
                <span class="summary-value" id="afterDiscountDisplay">0.00</span>
                <input type="hidden" name="after_discount" id="afterDiscount"
                    value="{{ document.after_discount if document else 0 }}">
            </div>
            <div class="summary-row">
                <label class="form-check summary-label">
                    <input type="checkbox" name="vat_enabled" id="vatEnabled" onchange="calcTotals()" {% if not document
                        or document.vat_enabled %}checked{% endif %}>
                    <span>‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 7%</span>
                </label>
                <span class="summary-value" id="vatDisplay">0.00</span>
                <input type="hidden" name="vat_amount" id="vatAmount"
                    value="{{ document.vat_amount if document else 0 }}">
            </div>
            <div class="summary-row grand-total">
                <span class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                <span class="summary-value" id="grandTotalDisplay">0.00</span>
                <input type="hidden" name="grand_total" id="grandTotal"
                    value="{{ document.grand_total if document else 0 }}">
            </div>
            <div class="summary-row" style="border-bottom:none;">
                <label class="form-check summary-label">
                    <input type="checkbox" name="withholding_tax_enabled" id="whtEnabled" onchange="calcTotals()" {% if
                        document and document.withholding_tax_enabled %}checked{% endif %}>
                    <span>‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</span>
                </label>
                <div class="discount-input-group">
                    <input type="number" name="withholding_tax_percent" id="whtPercent"
                        value="{{ document.withholding_tax_percent if document else 7 }}" step="any" min="0" max="100"
                        onchange="calcTotals()">
                    <span>%</span>
                </div>
                <span class="summary-value" id="whtDisplay">0.00</span>
                <input type="hidden" name="withholding_tax_amount" id="whtAmount"
                    value="{{ document.withholding_tax_amount if document else 0 }}">
            </div>
            <div class="summary-row" id="netTotalRow" style="display:none; border-bottom:none;">
                <span class="summary-label" style="font-weight:600;">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                <span class="summary-value" id="netTotalDisplay" style="color:var(--accent-green);">0.00</span>
                <input type="hidden" name="net_total" id="netTotal" value="{{ document.net_total if document else 0 }}">
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>

    function initCustomerAutocomplete() {
        console.log('Initializing custom autocomplete...');
        const customerInput = document.getElementById('customerName');
        const dropdown = document.getElementById('customerDropdown');
        if (!customerInput || !dropdown) return;

        let customers = [];

        // Fetch data
        fetch('/api/customers')
            .then(response => response.json())
            .then(data => {
                customers = data;
            })
            .catch(err => console.error('Error fetching customers:', err));

        // Render dropdown
        function renderDropdown(filterText = '') {
            dropdown.innerHTML = '';
            const filtered = customers.filter(c =>
                c.name.toLowerCase().includes(filterText.toLowerCase())
            );

            if (filtered.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            filtered.forEach(c => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = c.name;
                div.onclick = function () {
                    selectCustomer(c);
                };
                dropdown.appendChild(div);
            });
            dropdown.style.display = 'block';
        }

        function selectCustomer(customer) {
            customerInput.value = customer.name;
            dropdown.style.display = 'none';

            if (document.getElementsByName('customer_address')[0]) document.getElementsByName('customer_address')[0].value = customer.address || '';
            if (document.getElementsByName('customer_tax_id')[0]) document.getElementsByName('customer_tax_id')[0].value = customer.tax_id || '';
            if (document.getElementsByName('customer_branch')[0]) document.getElementsByName('customer_branch')[0].value = customer.branch || '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà';
            if (document.getElementsByName('customer_phone')[0]) document.getElementsByName('customer_phone')[0].value = customer.phone || '';
            if (document.getElementsByName('customer_zipcode')[0]) document.getElementsByName('customer_zipcode')[0].value = customer.zipcode || '';
        }

        // Event listeners
        customerInput.addEventListener('input', function () {
            renderDropdown(this.value);
        });

        customerInput.addEventListener('focus', function () {
            renderDropdown(this.value);
        });

        // Close when clicking outside
        document.addEventListener('click', function (e) {
            if (!customerInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
    }

    function addRow() {
        const tbody = document.getElementById('itemsBody');
        const rowCount = tbody.querySelectorAll('tr').length + 1;
        const tr = document.createElement('tr');
        tr.className = 'item-row';
        tr.innerHTML = `
            <td>${rowCount}</td>
            <td>
                <input type="text" name="item_description[]" value="" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£" class="form-control mb-1">
                <textarea name="item_details[]" class="form-control item-details-input" 
                    placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏Å‡∏î Shift+Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)" rows="1"></textarea>
            </td>
            <td><input type="number" name="item_quantity[]" value="" step="any" min="0" class="qty-input" onchange="calcRow(this)"></td>
            <td><input type="text" name="item_unit[]" value="" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢"></td>
            <td><input type="number" name="item_unit_price[]" value="" step="any" min="0" class="price-input" onchange="calcRow(this)"></td>
            <td class="amount-cell">
                <span class="row-amount">0.00</span>
                <input type="hidden" name="item_amount[]" value="0">
            </td>
            <td class="row-delete"><button type="button" onclick="removeRow(this)"><i class="ri-close-line"></i></button></td>
        `;
        tbody.appendChild(tr);
    }

    // Initialize calculations on load
    document.addEventListener('DOMContentLoaded', function () {
        calcTotals();
        initCustomerAutocomplete();
        updateDueDate();
    });

    // Close save dropdown when clicking outside
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.save-dropdown-wrapper')) {
            document.querySelectorAll('.save-dropdown-wrapper.open').forEach(d => d.classList.remove('open'));
        }
    });
</script>
{% endblock %}